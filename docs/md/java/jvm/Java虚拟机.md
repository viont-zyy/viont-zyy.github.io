# Java虚拟机

## JVM相关面试题

### 类的生命周期有哪些？其中的类加载过程讲一下

 一个类的完整生命周期包括类加载 — 类使用 — 类卸载。Class 文件加载到虚拟机中之后才能运行和使用，这个过程就是类加载。

类加载过程主要三步：**加载->连接->初始化**。连接过程又可分为三步：**验证->准备->解析**。

- 类的加载: 查找并加载类的二进制数据

- 连接 
  1. 验证: 确保被加载的类的正确性
  2. 准备: 为类的静态变量分配内存，并将其初始化为默认值
  3. 解析: 把类中的符号引用转换为直接引用

- 初始化：为类的静态变量赋予正确的初始值，JVM负责对类进行初始化，主要对类变量进行初始化。

- 使用： 类访问方法区内的数据结构的接口， 对象是Heap堆区的数据

- 卸载： 结束生命周期

### 介绍一下双亲委派机制？

双亲委派机制，是指如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把请求委托给父加载器去完成，依次向上，因此，所有的类加载请求最终都应该被传递到顶层的启动类加载器中，只有当父加载器在它的搜索范围中没有找到所需的类时，即无法完成该加载，子加载器才会尝试自己去加载该类。

- **双亲委派机制过程**

1. 当AppClassLoader加载一个class时，它首先不会自己去尝试加载这个类，而是把类加载请求委派给父类加载器ExtClassLoader去完成。
2. 当ExtClassLoader加载一个class时，它首先也不会自己去尝试加载这个类，而是把类加载请求委派给BootStrapClassLoader去完成。
3. 如果BootStrapClassLoader加载失败(例如在$JAVA_HOME/jre/lib里未查找到该class)，会使用ExtClassLoader来尝试加载；
4. 若ExtClassLoader也加载失败，则会使用AppClassLoader来加载，如果AppClassLoader也加载失败，则会报出异常ClassNotFoundException。

### 如何判断一个对象是否可以回收？

主要有两种判断方法，JVM采用的是后者。

- **引用计数算法**

给对象添加一个引用计数器，当对象增加一个引用时计数器加 1，引用失效时计数器减 1。引用计数为 0 的对象可被回收。

两个对象出现循环引用的情况下，此时引用计数器永远不为 0，导致无法对它们进行回收。正因为循环引用的存在，因此 Java 虚拟机不使用引用计数算法。

- **可达性分析算法**

通过 GC Roots 作为起始点进行搜索，能够到达到的对象都是存活的，不可达的对象可被回收。

Java 虚拟机使用该算法来判断对象是否可被回收，在 Java 中 GC Roots 一般包含以下内容:

- 虚拟机栈中引用的对象
- 本地方法栈中引用的对象
- 方法区中类静态属性引用的对象
- 方法区中的常量引用的对象